{% extends 'base.html' %}

{% block title %}Request to Borrow Item - Smart Supply Management System{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Request to Borrow Item</h1>
            <p class="text-gray-600">Submit a request to borrow items - GSO staff will review and approve</p>
        </div>
        <div class="mt-4 md:mt-0 flex gap-2">
            <a href="{% url 'request_borrow_batch' %}" 
               class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-list mr-2"></i>
                Batch Request
            </a>
            <a href="{% url 'request_list' %}" 
               class="inline-flex items-center px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Requests
            </a>
        </div>
    </div>
</div>

<!-- Borrow Request Form -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <form method="post">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="mb-6 bg-red-50 border-l-4 border-red-400 p-4 rounded">
                {% for error in form.non_field_errors %}
                    <p class="text-red-700 text-sm">{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        {% if not can_borrow %}
            <div class="mb-6 bg-red-50 border-l-4 border-red-400 p-4 rounded">
                <p class="text-red-800 text-sm">
                    You have {{ overdue_items.count }} overdue item(s). Please return them before borrowing new items.
                    <a href="{% url 'borrowed_items_list' %}" class="underline text-red-800 ml-2">View borrowed items</a>
                </p>
            </div>
        {% endif %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Supply Selection -->
            <div class="md:col-span-2">
                <label for="{{ form.supply.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-3">
                    Select Item to Borrow *
                </label>
                
                <!-- Non-Consumable Items Section (Equipment Only) -->
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-sm font-medium text-blue-900 mb-3">
                        <i class="fas fa-cube text-blue-600 mr-2"></i>ðŸ“¦ Equipment Items Only
                    </p>
                    <p class="text-sm text-blue-700 mb-3">
                        This form is for borrowing <strong>non-consumable equipment</strong> (items you can reuse like printers, keyboards, monitors, etc.)
                    </p>
                </div>
                
                <div class="mb-3">
                    <div class="inline-flex rounded-md shadow-sm" role="tablist" aria-label="Select type">
                        <button type="button" class="type-filter-btn px-3 py-2 bg-indigo-600 text-white rounded-l-md" data-filter="equipment">Equipment</button>
                        <button type="button" class="type-filter-btn px-3 py-2 bg-white text-gray-700 border-l" data-filter="materials">Materials</button>
                    </div>
                </div>

                <!-- Search Input -->
                <div class="mb-3">
                    <input type="text" id="supply-search" class="form-input block w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Search items by name or category...">
                </div>

                <select id="{{ form.supply.id_for_label }}" name="{{ form.supply.name }}" class="form-select block w-full px-4 py-2 border border-gray-300 rounded-lg" aria-label="Select item to borrow">
                    <option value="">-- Select item to borrow --</option>
                    {% for supply in form.supply.field.queryset %}
                        {% comment %} Determine if this supply is a material by category flag or non-consumable equipment {% endcomment %}
                        {% with is_material=supply.category.is_material is_consumable=supply.is_consumable %}
                        <option value="{{ supply.pk }}" data-is-material="{{ is_material|yesno:'1,0' }}" data-is-consumable="{{ is_consumable|yesno:'1,0' }}" data-name="{{ supply.name|lower|escapejs }}" data-category="{{ supply.category.name|lower|escapejs }}">
                            {{ supply.name }} ({{ supply.quantity }} {{ supply.unit }} available)
                        </option>
                        {% endwith %}
                    {% endfor %}
                </select>
                <p id="supply-help" class="mt-1 text-sm text-gray-500">
                    <i class="fas fa-check-circle mr-1 text-green-600"></i>Only available equipment items are shown
                </p>
                
                {% if form.supply.errors %}
                    <p class="mt-2 text-sm text-red-600">{{ form.supply.errors.0 }}</p>
                {% endif %}
                
                <!-- Selected Item Display -->
                <div id="selected-item-info" class="mt-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded hidden">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Selected Item:</p>
                            <p id="selected-item-name" class="text-lg font-semibold text-indigo-900 mt-1"></p>
                            <p id="selected-item-type" class="text-xs text-indigo-600 mt-1"></p>
                            <p id="selected-item-location" class="text-xs text-indigo-600 mt-1"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Available:</p>
                            <p id="available-qty" class="text-2xl font-bold text-indigo-700 mt-1">0</p>
                            <p id="available-unit" class="text-xs text-indigo-600 mt-1">units</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quantity -->
            <div>
                <label for="{{ form.quantity_requested.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Quantity *
                </label>
                {{ form.quantity_requested }}
                {% if form.quantity_requested.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.quantity_requested.errors.0 }}</p>
                {% else %}
                    <p class="mt-1 text-sm text-gray-500">How many items do you need?</p>
                {% endif %}
            </div>
            
            <!-- Borrow Duration -->
            <div>
                <label for="{{ form.borrow_duration_days.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Duration (Days) *
                </label>
                {{ form.borrow_duration_days }}
                {% if form.borrow_duration_days.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.borrow_duration_days.errors.0 }}</p>
                {% else %}
                    <p class="mt-1 text-sm text-gray-500">How many days do you need to borrow? (default: 3)</p>
                {% endif %}
            </div>
            
            <!-- Purpose -->
            <div class="md:col-span-2">
                <label for="{{ form.purpose.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Purpose of Borrowing *
                </label>
                {{ form.requested_location }}
                <div class="mt-3"></div>
                {{ form.purpose }}
                {% if form.purpose.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.purpose.errors.0 }}</p>
                {% else %}
                    <p class="mt-1 text-sm text-gray-500">Describe why you need to borrow this item</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Info Box -->
        <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-400 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Next Steps</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <ol class="list-decimal list-inside space-y-1">
                            <li>Submit your borrow request</li>
                            <li>GSO staff will review your request</li>
                            <li>When approved, GSO staff will set the exact borrow date and return deadline</li>
                            <li>Your borrowed items will appear in "My Borrowed Items"</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Submit Buttons -->
        <div class="mt-6 flex gap-3">
            {% if can_borrow %}
                <button type="submit" 
                        class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Submit Borrow Request
                </button>
            {% else %}
                <button type="button" disabled 
                        class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white text-sm font-medium rounded-lg opacity-50 cursor-not-allowed">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Submit Borrow Request
                </button>
            {% endif %}
            <a href="{% url 'dashboard' %}" 
               class="inline-flex items-center px-6 py-3 bg-gray-300 text-gray-800 text-sm font-medium rounded-lg hover:bg-gray-400 transition-colors">
                Cancel
            </a>
        </div>
    </form>
</div>

<!-- Important Info -->
<div class="mt-8 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-yellow-800">Important Notes</h3>
            <div class="mt-2 text-sm text-yellow-700">
                <ul class="list-disc list-inside space-y-1">
                    <li>You cannot borrow items if you have overdue items. Please return them first.</li>
                    <li>GSO staff must approve your request before you can collect the item</li>
                    <li>You must return the item by the deadline set by GSO staff</li>
                    <li>Late returns may prevent you from borrowing items in the future</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const supplySelect = document.getElementById('{{ form.supply.id_for_label }}');
    const selectedItemInfo = document.getElementById('selected-item-info');
    const selectedItemName = document.getElementById('selected-item-name');
    const selectedItemType = document.getElementById('selected-item-type');
    const availableQty = document.getElementById('available-qty');
    const availableUnit = document.getElementById('available-unit');
    const quantityInput = document.getElementById('{{ form.quantity_requested.id_for_label }}');
    
    // Supply data (populated from server-side queryset)
    const supplyData = {};

    {% for supply in form.supply.field.queryset %}
        supplyData[{{ supply.id }}] = {
            name: '{{ supply.name|escapejs }}',
            category: '{{ supply.category.name|escapejs }}',
            stock: {{ supply.quantity }},
            unit: '{{ supply.unit|escapejs }}',
            minStock: {{ supply.min_stock_level }},
            isConsumable: {{ supply.is_consumable|yesno:'true,false' }},
            isMaterial: {{ supply.category.is_material|yesno:'true,false' }},
            location: '{{ supply.location|escapejs }}'
        };
    {% endfor %}
    
    // Type filter buttons
    const typeButtons = document.querySelectorAll('.type-filter-btn');
    const supplyHelp = document.getElementById('supply-help');
    const searchInput = document.getElementById('supply-search');
    let currentFilter = 'equipment';

    function applyFilters() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
        Array.from(supplySelect.options).forEach(opt => {
            if (!opt.value) return; // skip placeholder
            
            // Type filter logic
            const dsIsMat = opt.dataset.isMaterial === '1';
            const dsIsCons = opt.dataset.isConsumable === '1';
            const sd = supplyData[opt.value];
            const sdIsMat = sd ? sd.isMaterial === 'true' || sd.isMaterial === true : false;
            const sdIsCons = sd ? sd.isConsumable === 'true' || sd.isConsumable === true : false;

            const isMat = dsIsMat || sdIsMat;
            const isCons = dsIsCons || sdIsCons;

            let typeMatch = false;
            if (currentFilter === 'equipment') {
                typeMatch = !isCons;
            } else if (currentFilter === 'materials') {
                typeMatch = isMat;
            }

            // Search filter logic
            let searchMatch = true;
            if (searchTerm) {
                const itemName = opt.dataset.name || '';
                const itemCategory = opt.dataset.category || '';
                searchMatch = itemName.includes(searchTerm) || itemCategory.includes(searchTerm);
            }

            // Apply combined filters
            const shouldShow = typeMatch && searchMatch;
            opt.style.display = shouldShow ? '' : 'none';
            opt.disabled = !shouldShow;
        });
    }

    function setActiveFilter(filter) {
        currentFilter = filter;
        typeButtons.forEach(b => {
            if (b.dataset.filter === filter) {
                b.classList.add('bg-indigo-600', 'text-white');
                b.classList.remove('bg-white', 'text-gray-700');
            } else {
                b.classList.remove('bg-indigo-600', 'text-white');
                b.classList.add('bg-white', 'text-gray-700');
            }
        });

        // Update help text
        supplyHelp.textContent = filter === 'equipment'
            ? 'Only available equipment items are shown'
            : 'Only available material items are shown';
        
        applyFilters();
    }

    typeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            setActiveFilter(this.dataset.filter);
            // reset selection
            supplySelect.value = '';
            supplySelect.dispatchEvent(new Event('change'));
        });
    });

    // Add search input listener
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            applyFilters();
            // reset selection when search changes
            supplySelect.value = '';
            supplySelect.dispatchEvent(new Event('change'));
        });
    }

    // set default filter to equipment
    setActiveFilter('equipment');

    // Update equipment/material information when selection changes
    supplySelect.addEventListener('change', function() {
        const selectedId = this.value;
        
        if (selectedId && supplyData[selectedId]) {
            const supply = supplyData[selectedId];
            
            // Update display
            selectedItemName.textContent = supply.name;
            selectedItemType.textContent = supply.isMaterial ? '(Material)' : '(Equipment - Non-Consumable)';
            availableQty.textContent = supply.stock;
            availableUnit.textContent = supply.unit || 'units';
            // Show current storage location of the supply
            const locEl = document.getElementById('selected-item-location');
            if (locEl) locEl.textContent = 'Current location: ' + (supply.location || 'Unknown');
            
            // Show item info
            selectedItemInfo.classList.remove('hidden');
            
            // Update quantity input max and validation
            quantityInput.max = supply.stock;
            
            // Add validation
            quantityInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value > supply.stock) {
                    this.setCustomValidity('Quantity cannot exceed available stock (' + supply.stock + ' ' + supply.unit + ')');
                } else if (value <= 0) {
                    this.setCustomValidity('Quantity must be greater than 0');
                } else {
                    this.setCustomValidity('');
                }
            });
        } else {
            // Hide item info if no selection
            selectedItemInfo.classList.add('hidden');
        }
    });
    
    // Trigger change event if there's a pre-selected value
    if (supplySelect.value) {
        supplySelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
