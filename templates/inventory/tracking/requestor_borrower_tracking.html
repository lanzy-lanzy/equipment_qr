{% extends "base.html" %}
{% load static %}

{% block title %}Requestor & Borrower Tracking{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Requestor & Borrower Tracking</h1>
        <p class="text-gray-600">Track and manage all user requests and borrowing activities</p>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Users</p>
                    <p class="text-3xl font-bold text-gray-900">{{ users.count }}</p>
                </div>
                <div class="p-3 bg-blue-100 rounded-full">
                    <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Active Borrowers</p>
                    <p class="text-3xl font-bold text-gray-900">{{ active_borrowers }}</p>
                </div>
                <div class="p-3 bg-green-100 rounded-full">
                    <i class="fas fa-hand-holding text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Requests</p>
                    <p class="text-3xl font-bold text-gray-900">{{ total_requests }}</p>
                </div>
                <div class="p-3 bg-yellow-100 rounded-full">
                    <i class="fas fa-clipboard-list text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Overdue Items</p>
                    <p class="text-3xl font-bold text-red-600">0</p>
                </div>
                <div class="p-3 bg-red-100 rounded-full">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Department Users</h2>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200 bg-gray-50">
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">User</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Department</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Total Requests</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Approved</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Items Borrowed</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Unreturned</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Last Activity</th>
                        <th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                    {{ user.username|first|upper }}
                                </div>
                                <span class="font-medium">{{ user.username }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">{{ user.department|default:"N/A" }}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 font-semibold">
                                {% if user.analytics %}{{ user.analytics.total_requests }}{% else %}0{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-700 font-semibold">
                                {% if user.analytics %}{{ user.analytics.approved_requests }}{% else %}0{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 text-purple-700 font-semibold">
                                {% if user.analytics %}{{ user.analytics.total_borrowings }}{% else %}0{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            {% if user.analytics.overdue_items > 0 or user.analytics.total_borrowings|add:"-"|add:user.analytics.returned_items > 0 %}
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-700 font-semibold">
                                    {% if user.analytics %}{{ user.analytics.total_borrowings|add:"-"|add:user.analytics.returned_items }}{% else %}0{% endif %}
                                </span>
                            {% else %}
                                <span class="text-gray-400">0</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-center text-sm text-gray-600">
                            {% if user.analytics.last_request_date or user.analytics.last_borrow_date %}
                                {% if user.analytics.last_request_date and user.analytics.last_borrow_date %}
                                    {% if user.analytics.last_request_date > user.analytics.last_borrow_date %}
                                        {{ user.analytics.last_request_date|timesince }} ago
                                    {% else %}
                                        {{ user.analytics.last_borrow_date|timesince }} ago
                                    {% endif %}
                                {% elif user.analytics.last_request_date %}
                                    {{ user.analytics.last_request_date|timesince }} ago
                                {% else %}
                                    {{ user.analytics.last_borrow_date|timesince }} ago
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="openUserModal({{ user.id }}, '{{ user.username }}')" 
                               class="inline-flex items-center space-x-1 px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors text-sm font-medium">
                                <i class="fas fa-chart-bar"></i>
                                <span>View</span>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-3 text-gray-300"></i>
                            <p>No department users found</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeUserModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div id="modalUserAvatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold"></div>
                <div>
                    <h2 id="modalUserName" class="text-xl font-bold text-gray-900"></h2>
                    <p id="modalUserDept" class="text-sm text-gray-600"></p>
                </div>
            </div>
            <button onclick="closeUserModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6" id="modalContent">
            <div class="flex items-center justify-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                <span class="ml-3 text-gray-600">Loading user details...</span>
            </div>
        </div>
    </div>
</div>

<style>
    /* Fix for template filter approximation */
    .bg-blue-100 { @apply bg-blue-100; }
    .text-blue-700 { @apply text-blue-700; }
    .bg-green-100 { @apply bg-green-100; }
    .text-green-700 { @apply text-green-700; }
    .bg-purple-100 { @apply bg-purple-100; }
    .text-purple-700 { @apply text-purple-700; }
    .bg-red-100 { @apply bg-red-100; }
    .text-red-700 { @apply text-red-700; }
</style>

<script>
function openUserModal(userId, username) {
    const modal = document.getElementById('userDetailsModal');
    const avatar = document.getElementById('modalUserAvatar');
    const nameEl = document.getElementById('modalUserName');
    const deptEl = document.getElementById('modalUserDept');
    const content = document.getElementById('modalContent');
    
    // Set user info
    const initials = username.charAt(0).toUpperCase();
    const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500'];
    const colorIndex = username.charCodeAt(0) % colors.length;
    
    avatar.className = `w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold ${colors[colorIndex]}`;
    avatar.textContent = initials;
    nameEl.textContent = username;
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Fetch user details
    fetch(`/analytics/user/${userId}/modal/`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to load user details');
        return response.text();
    })
    .then(html => {
        content.innerHTML = html;
        deptEl.textContent = document.querySelector('#modalContent [data-dept]')?.getAttribute('data-dept') || 'N/A';
    })
    .catch(error => {
        console.error('Error:', error);
        content.innerHTML = `<div class="text-center py-8"><p class="text-red-600">Error loading user details. Please try again.</p></div>`;
    });
}

function closeUserModal(event) {
    // Allow closing by clicking the X button or the background
    if (event && event.target.id !== 'userDetailsModal') return;
    
    const modal = document.getElementById('userDetailsModal');
    modal.classList.add('hidden');
}
</script>
{% endblock %}
